# ðŸ—ï¸ ARCHITECTURE OVERVIEW

> **traffic-mqtt-demo** â€” Kiáº¿n trÃºc há»‡ thá»‘ng giÃ¡m sÃ¡t Ä‘Ã¨n giao thÃ´ng qua IoTâ€“MQTT

---

## 1. SÆ¡ Äá»“ Kiáº¿n TrÃºc

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DOCKER HOST (PC)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        docker-compose.yml                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚  â”‚  â”‚   MOSQUITTO     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   NODE-RED      â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚   :1883         â”‚  MQTT   â”‚   :1880         â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚   (Broker)      â”‚         â”‚   (Dashboard)   â”‚                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                                                              â”‚
â”‚              â”‚ MQTT (QoS 0/1)                                               â”‚
â”‚              â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        PYTHON TOOLS                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚   mock_esp32    â”‚  â”‚   smoke_test    â”‚  â”‚   benchmark     â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   (Simulator)   â”‚  â”‚   (QA)          â”‚  â”‚   (RTT Report)  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ WiFi + MQTT
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ESP32 (Edge Device)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WiFi â†’ MQTT Client â†’ FSM (AUTO/MANUAL/BLINK/OFF) â†’ GPIO â†’ LEDs     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Luá»“ng Dá»¯ Liá»‡u

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     cmd (QoS 1)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     cmd (QoS 1)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node-RED   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Mosquitto  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    ESP32    â”‚
â”‚  Dashboard  â”‚                      â”‚   Broker    â”‚                      â”‚    Edge     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                    â”‚                                    â”‚
      â”‚                                    â”‚                                    â”‚
      â”‚         ack (QoS 1)                â”‚         ack (QoS 1)                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                            state (QoS 0)                               â”‚
      â–¼                                    â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  Node-RED   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Mosquitto  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Dashboard  â”‚                      â”‚   Broker    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ (Display RTT, Mode, Phase)
      â–¼
   [Browser UI]
```

### Sequence Diagram (SET_MODE)

```
User        Node-RED      Mosquitto       ESP32
 â”‚            â”‚              â”‚              â”‚
 â”‚â”€â”€Clickâ”€â”€â”€â”€â–ºâ”‚              â”‚              â”‚
 â”‚            â”‚â”€â”€publishâ”€â”€â”€â”€â–ºâ”‚              â”‚
 â”‚            â”‚  cmd/        â”‚â”€â”€forwardâ”€â”€â”€â”€â–ºâ”‚
 â”‚            â”‚              â”‚              â”‚â”€â”€Process FSM
 â”‚            â”‚              â”‚              â”‚â”€â”€Update GPIO
 â”‚            â”‚              â”‚â—„â”€â”€ackâ”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚â—„â”€â”€RTTâ”€â”€â”€â”€â”€â”€â”‚              â”‚              â”‚
 â”‚            â”‚              â”‚â—„â”€â”€stateâ”€â”€â”€â”€â”€â”€â”‚
 â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚â—„â”€â”€Updateâ”€â”€â”€â”‚              â”‚              â”‚
```

---

## 3. MQTT Topic Map

> **Base prefix:** `city/demo/intersection/001`

| Topic           | Direction         | QoS | Retained | Purpose                                   |
| --------------- | ----------------- | --- | -------- | ----------------------------------------- |
| `.../cmd`       | Dashboard â†’ ESP32 | 1   | No       | Commands (SET_MODE, SET_PHASE, EMERGENCY) |
| `.../ack`       | ESP32 â†’ Dashboard | 1   | No       | Command acknowledgement with cmd_id       |
| `.../state`     | ESP32 â†’ All       | 0   | No       | Current mode, phase, LED states (1Hz)     |
| `.../status`    | ESP32 â†’ All       | 1   | Yes      | LWT: "ONLINE" / "OFFLINE"                 |
| `.../telemetry` | ESP32 â†’ Logger    | 0   | No       | WiFi RSSI, heap, uptime (5s interval)     |

### Full Topic Paths

```
city/demo/intersection/001/cmd
city/demo/intersection/001/ack
city/demo/intersection/001/state
city/demo/intersection/001/status
city/demo/intersection/001/telemetry
```

---

## 4. What Runs Where

| Component          | Runs On                           | Technology               | Port |
| ------------------ | --------------------------------- | ------------------------ | ---- |
| **Mosquitto**      | Docker (PC)                       | Eclipse Mosquitto 2.x    | 1883 |
| **Node-RED**       | Docker (PC)                       | Node-RED + Dashboard     | 1880 |
| **Python Tools**   | PC (native)                       | Python 3.11+             | -    |
| **ESP32 Firmware** | ESP32 DevKit                      | ESP-IDF 5.5 (primary)    | -    |
| **Dark Dashboard** | Browser (via Node-RED httpStatic) | HTML + MQTT.js WebSocket | 9001 |

---

## 5. Directory Structure

```
traffic-mqtt-demo/
â”œâ”€â”€ docker-compose.yml          # Docker services orchestration
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ mosquitto/
â”‚   â”‚   â”œâ”€â”€ mosquitto.conf      # Broker configuration
â”‚   â”‚   â”œâ”€â”€ aclfile             # Access control list
â”‚   â”‚   â””â”€â”€ pwfile              # Password file (generated)
â”‚   â””â”€â”€ nodered/data/           # Node-RED persistent data
â”œâ”€â”€ esp32_idf/                    # ESP-IDF 5.5 firmware (PRIMARY)
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â””â”€â”€ main/
â”‚       â”œâ”€â”€ app_main.c          # Entry point, publisher task
â”‚       â”œâ”€â”€ fsm_controller.c    # Traffic light FSM (6 phases)
â”‚       â”œâ”€â”€ mqtt_handler.c      # MQTT client, cmd/ack handling
â”‚       â”œâ”€â”€ gpio_lights.c       # LED GPIO driver
â”‚       â”œâ”€â”€ wifi_manager.c      # WiFi STA connection
â”‚       â””â”€â”€ Kconfig.projbuild   # Menuconfig options
â”œâ”€â”€ dashboard/
â”‚   â””â”€â”€ index.html              # Dark-themed standalone dashboard
â”œâ”€â”€ logger/tools/
â”‚   â”œâ”€â”€ mock_esp32.py           # ESP32 simulator
â”‚   â”œâ”€â”€ smoke_test.py           # E2E smoke test
â”‚   â”œâ”€â”€ run_benchmark_report.py # RTT benchmark + report
â”‚   â””â”€â”€ analyze_results.py      # CSV analyzer
â”œâ”€â”€ node-red/flows.json         # Dashboard flows (backup)
â”œâ”€â”€ SPEC.md                     # Protocol specification
â”œâ”€â”€ RUNBOOK.md                  # Quick start guide
â””â”€â”€ QA_CHECKLIST.md             # QA test checklist
```

---

## 6. Dependencies

| Service        | Dependency  | Version                                     |
| -------------- | ----------- | ------------------------------------------- |
| Mosquitto      | Docker      | eclipse-mosquitto:2                         |
| Node-RED       | Docker      | nodered/node-red:latest                     |
| Python Tools   | Local       | Python 3.11+, paho-mqtt, pandas, matplotlib |
| ESP32 Firmware | ESP-IDF 5.5 | esp_mqtt, cJSON (managed components)        |
| Dashboard      | Browser     | HTML + mqtt.min.js (WebSocket)              |

---

> ðŸ“š Xem thÃªm: [SPEC.md](../SPEC.md) | [API.md](API.md) | [SPEC_IMPLEMENTATION_MATRIX.md](SPEC_IMPLEMENTATION_MATRIX.md)
