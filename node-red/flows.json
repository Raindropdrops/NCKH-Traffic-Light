[
    {
        "id": "flow.traffic-dashboard",
        "type": "tab",
        "label": "Traffic Light Dashboard",
        "disabled": false,
        "info": "Traffic Light MQTT Control Dashboard - SPEC.md compliant\nBase topic: city/demo/intersection/001"
    },
    {
        "id": "mqtt-broker.local",
        "type": "mqtt-broker",
        "name": "Mosquitto Local",
        "broker": "mosquitto",
        "port": "1883",
        "clientid": "nodered-dashboard",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": "",
        "credentials": {
            "user": "demo",
            "password": "demo_pass"
        }
    },
    {
        "id": "ui-tab.main",
        "type": "ui_tab",
        "name": "Traffic Control",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "ui-group.control",
        "type": "ui_group",
        "name": "ðŸŽ® Control",
        "tab": "ui-tab.main",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "ui-group.intersection",
        "type": "ui_group",
        "name": "ðŸš¦ Intersection View",
        "tab": "ui-tab.main",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "ui-group.live",
        "type": "ui_group",
        "name": "ðŸ“Š Live Status",
        "tab": "ui-tab.main",
        "order": 3,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "ui-group.telemetry",
        "type": "ui_group",
        "name": "ðŸ“¡ Telemetry",
        "tab": "ui-tab.main",
        "order": 4,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "ui-group.acklog",
        "type": "ui_group",
        "name": "ðŸ“‹ ACK Log",
        "tab": "ui-tab.main",
        "order": 5,
        "disp": true,
        "width": "12",
        "collapse": false
    },

    {"id":"comment.header","type":"comment","z":"flow.traffic-dashboard","name":"ðŸš¦ Traffic Light Dashboard â€” SPEC.md Compliant","info":"Base: city/demo/intersection/001\nTopics: cmd/ack/state/status/telemetry","x":280,"y":40,"wires":[]},

    {
        "id": "ui.ctrl.mode-dropdown",
        "type": "ui_dropdown",
        "z": "flow.traffic-dashboard",
        "name": "Mode Select",
        "group": "ui-group.control",
        "order": 1,
        "width": "4",
        "height": "1",
        "passthru": true,
        "multiple": false,
        "options": [
            {"label": "AUTO", "value": "AUTO", "type": "str"},
            {"label": "MANUAL", "value": "MANUAL", "type": "str"},
            {"label": "BLINK", "value": "BLINK", "type": "str"},
            {"label": "OFF", "value": "OFF", "type": "str"}
        ],
        "payload": "AUTO",
        "topic": "mode",
        "topicType": "str",
        "className": "",
        "x": 160,
        "y": 100,
        "wires": [["holder.mode"]]
    },
    {
        "id": "holder.mode",
        "type": "change",
        "z": "flow.traffic-dashboard",
        "name": "Hold Mode",
        "rules": [{"t": "set", "p": "selected_mode", "pt": "flow", "to": "payload", "tot": "msg"}],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 100,
        "wires": [[]]
    },
    {
        "id": "btn.send-mode",
        "type": "ui_button",
        "z": "flow.traffic-dashboard",
        "name": "Send SET_MODE",
        "group": "ui-group.control",
        "order": 2,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "Send SET_MODE",
        "tooltip": "Send SET_MODE command",
        "color": "#ffffff",
        "bgcolor": "#4CAF50",
        "className": "",
        "icon": "fa-paper-plane",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "topicType": "str",
        "x": 170,
        "y": 140,
        "wires": [["func.build-set-mode"]]
    },
    {
        "id": "func.build-set-mode",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Build SET_MODE",
        "func": "const mode = flow.get('selected_mode') || 'AUTO';\nconst uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n});\nmsg.payload = JSON.stringify({\n    cmd_id: uuid,\n    type: 'SET_MODE',\n    mode: mode,\n    ts_ms: Date.now()\n});\nmsg.qos = 1;\nmsg.retain = false;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 140,
        "wires": [["mqtt.cmd.out", "debug.cmd"]]
    },

    {
        "id": "ui.ctrl.phase-dropdown",
        "type": "ui_dropdown",
        "z": "flow.traffic-dashboard",
        "name": "Phase Select",
        "group": "ui-group.control",
        "order": 3,
        "width": "4",
        "height": "1",
        "passthru": true,
        "multiple": false,
        "options": [
            {"label": "0: NS_GREEN", "value": 0, "type": "num"},
            {"label": "1: NS_YELLOW", "value": 1, "type": "num"},
            {"label": "2: ALL_RED", "value": 2, "type": "num"},
            {"label": "3: EW_GREEN", "value": 3, "type": "num"},
            {"label": "4: EW_YELLOW", "value": 4, "type": "num"},
            {"label": "5: ALL_RED", "value": 5, "type": "num"}
        ],
        "payload": "0",
        "topic": "phase",
        "topicType": "str",
        "className": "",
        "x": 160,
        "y": 200,
        "wires": [["holder.phase"]]
    },
    {
        "id": "holder.phase",
        "type": "change",
        "z": "flow.traffic-dashboard",
        "name": "Hold Phase",
        "rules": [{"t": "set", "p": "selected_phase", "pt": "flow", "to": "payload", "tot": "msg"}],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 200,
        "wires": [[]]
    },
    {
        "id": "btn.send-phase",
        "type": "ui_button",
        "z": "flow.traffic-dashboard",
        "name": "Send SET_PHASE",
        "group": "ui-group.control",
        "order": 4,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "Send SET_PHASE",
        "tooltip": "Send SET_PHASE command",
        "color": "#ffffff",
        "bgcolor": "#2196F3",
        "className": "",
        "icon": "fa-paper-plane",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "topicType": "str",
        "x": 170,
        "y": 240,
        "wires": [["func.build-set-phase"]]
    },
    {
        "id": "func.build-set-phase",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Build SET_PHASE",
        "func": "const phase = flow.get('selected_phase');\nconst p = (phase !== null && phase !== undefined) ? Number(phase) : 0;\nconst uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n});\nmsg.payload = JSON.stringify({\n    cmd_id: uuid,\n    type: 'SET_PHASE',\n    phase: p,\n    ts_ms: Date.now()\n});\nmsg.qos = 1;\nmsg.retain = false;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 240,
        "wires": [["mqtt.cmd.out", "debug.cmd"]]
    },

    {
        "id": "mqtt.cmd.out",
        "type": "mqtt out",
        "z": "flow.traffic-dashboard",
        "name": "â†’ cmd (QoS1)",
        "topic": "city/demo/intersection/001/cmd",
        "qos": "1",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "mqtt-broker.local",
        "x": 590,
        "y": 175,
        "wires": []
    },
    {
        "id": "debug.cmd",
        "type": "debug",
        "z": "flow.traffic-dashboard",
        "name": "CMD Sent",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 590,
        "y": 225,
        "wires": []
    },

    {
        "id": "mqtt.state.in",
        "type": "mqtt in",
        "z": "flow.traffic-dashboard",
        "name": "â† state (QoS0)",
        "topic": "city/demo/intersection/001/state",
        "qos": "0",
        "datatype": "json",
        "broker": "mqtt-broker.local",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 400,
        "wires": [["func.parse-state", "func.intersection-svg"]]
    },
    {
        "id": "func.parse-state",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Parse State â†’ Live",
        "func": "const data = msg.payload;\nconst phaseNames = ['NS_GREEN','NS_YELLOW','ALL_RED','EW_GREEN','EW_YELLOW','ALL_RED'];\nconst m1 = {payload: data.mode || 'UNKNOWN'};\nconst m2 = {payload: (data.phase !== undefined ? data.phase + ': ' + (phaseNames[data.phase]||'?') : '?')};\nconst m3 = {payload: (data.uptime_s || 0) + 's'};\nreturn [m1, m2, m3];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 400,
        "wires": [["ui.live.mode"], ["ui.live.phase"], ["ui.live.uptime"]]
    },
    {"id":"ui.live.mode","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.live","order":2,"width":"3","height":"1","name":"Mode","label":"Mode:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":380,"wires":[]},
    {"id":"ui.live.phase","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.live","order":3,"width":"3","height":"1","name":"Phase","label":"Phase:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":420,"wires":[]},
    {"id":"ui.live.uptime","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.live","order":4,"width":"3","height":"1","name":"Uptime","label":"Uptime:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":460,"wires":[]},

    {
        "id": "mqtt.status.in",
        "type": "mqtt in",
        "z": "flow.traffic-dashboard",
        "name": "â† status (QoS1 retained)",
        "topic": "city/demo/intersection/001/status",
        "qos": "1",
        "datatype": "json",
        "broker": "mqtt-broker.local",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 340,
        "wires": [["func.parse-status"]]
    },
    {
        "id": "func.parse-status",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Parse Status",
        "func": "const data = msg.payload;\nconst online = data.online ? 'ðŸŸ¢ ONLINE' : 'ðŸ”´ OFFLINE';\nconst ts = data.ts_ms ? new Date(data.ts_ms).toLocaleTimeString() : new Date().toLocaleTimeString();\nmsg.payload = online + ' (' + ts + ')';\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 340,
        "wires": [["ui.live.online"]]
    },
    {"id":"ui.live.online","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.live","order":1,"width":"6","height":"1","name":"Online","label":"Status:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":340,"wires":[]},

    {
        "id": "mqtt.telemetry.in",
        "type": "mqtt in",
        "z": "flow.traffic-dashboard",
        "name": "â† telemetry (QoS0)",
        "topic": "city/demo/intersection/001/telemetry",
        "qos": "0",
        "datatype": "json",
        "broker": "mqtt-broker.local",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 500,
        "wires": [["func.parse-telemetry"]]
    },
    {
        "id": "func.parse-telemetry",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Parse Telemetry",
        "func": "const d = msg.payload;\nreturn [\n    {payload: (d.rssi_dbm||0)+' dBm'},\n    {payload: (d.heap_free_kb||0)+' KB'},\n    {payload: (d.uptime_s||0)+'s'}\n];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 500,
        "wires": [["ui.telem.rssi"], ["ui.telem.heap"], ["ui.telem.uptime"]]
    },
    {"id":"ui.telem.rssi","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.telemetry","order":1,"width":"4","height":"1","name":"RSSI","label":"ðŸ“¶ RSSI:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":490,"wires":[]},
    {"id":"ui.telem.heap","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.telemetry","order":2,"width":"4","height":"1","name":"Heap","label":"ðŸ’¾ Heap:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":520,"wires":[]},
    {"id":"ui.telem.uptime","type":"ui_text","z":"flow.traffic-dashboard","group":"ui-group.telemetry","order":3,"width":"4","height":"1","name":"Uptime T","label":"â±ï¸ Uptime:","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":570,"y":550,"wires":[]},

    {
        "id": "mqtt.ack.in",
        "type": "mqtt in",
        "z": "flow.traffic-dashboard",
        "name": "â† ack (QoS1)",
        "topic": "city/demo/intersection/001/ack",
        "qos": "1",
        "datatype": "json",
        "broker": "mqtt-broker.local",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 600,
        "wires": [["func.ack-log"]]
    },
    {
        "id": "func.ack-log",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "ACK Log (10 entries)",
        "func": "let log = flow.get('ack_log') || [];\nconst d = msg.payload;\nlog.unshift({\n    t: new Date().toLocaleTimeString(),\n    id: (d.cmd_id||'').substring(0,8),\n    ok: d.ok ? 'âœ…' : 'âŒ',\n    err: d.err || '-',\n    ts: d.edge_recv_ts_ms || 0\n});\nif (log.length > 10) log.pop();\nflow.set('ack_log', log);\nlet h='<table style=\"width:100%;font-size:11px;border-collapse:collapse;\">';\nh+='<tr style=\"background:#333;color:#fff;\"><th>Time</th><th>CMD ID</th><th>OK</th><th>Error</th><th>Edge TS</th></tr>';\nlog.forEach((e,i)=>{\n    const bg=i%2===0?'#f9f9f9':'#fff';\n    h+=`<tr style=\"background:${bg}\"><td>${e.t}</td><td>${e.id}â€¦</td><td>${e.ok}</td><td>${e.err}</td><td>${e.ts}</td></tr>`;\n});\nh+='</table>';\nmsg.payload = h;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 600,
        "wires": [["ui.ack.log"]]
    },
    {
        "id": "ui.ack.log",
        "type": "ui_template",
        "z": "flow.traffic-dashboard",
        "group": "ui-group.acklog",
        "name": "ACK Table",
        "order": 1,
        "width": "12",
        "height": "5",
        "format": "<div ng-bind-html=\"msg.payload\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 560,
        "y": 600,
        "wires": [[]]
    },

    {
        "id": "func.intersection-svg",
        "type": "function",
        "z": "flow.traffic-dashboard",
        "name": "Build Intersection SVG",
        "func": "const phase = msg.payload.phase;\n// Phase mapping: N=S mirror, E=W mirror\n// 0:NS_GREEN 1:NS_YELLOW 2:ALL_RED 3:EW_GREEN 4:EW_YELLOW 5:ALL_RED\nconst colors = {\n    ns: {r:'#333',y:'#333',g:'#333'},\n    ew: {r:'#333',y:'#333',g:'#333'}\n};\nswitch(phase) {\n    case 0: colors.ns.g='#00FF00'; colors.ew.r='#FF0000'; break;\n    case 1: colors.ns.y='#FFFF00'; colors.ew.r='#FF0000'; break;\n    case 2: colors.ns.r='#FF0000'; colors.ew.r='#FF0000'; break;\n    case 3: colors.ew.g='#00FF00'; colors.ns.r='#FF0000'; break;\n    case 4: colors.ew.y='#FFFF00'; colors.ns.r='#FF0000'; break;\n    case 5: colors.ns.r='#FF0000'; colors.ew.r='#FF0000'; break;\n    default: colors.ns.r='#FF0000'; colors.ew.r='#FF0000';\n}\nconst phaseNames=['NS_GREEN','NS_YELLOW','ALL_RED','EW_GREEN','EW_YELLOW','ALL_RED'];\nconst pName = phaseNames[phase] || 'UNKNOWN';\n\nfunction light(cx,cy,ns,label){\n    const c = ns ? colors.ns : colors.ew;\n    return `<g>\n        <rect x=\"${cx-18}\" y=\"${cy-30}\" width=\"36\" height=\"76\" rx=\"6\" fill=\"#222\" stroke=\"#555\" stroke-width=\"1\"/>\n        <circle cx=\"${cx}\" cy=\"${cy-16}\" r=\"10\" fill=\"${c.r}\" stroke=\"#444\" stroke-width=\"1\"/>\n        <circle cx=\"${cx}\" cy=\"${cy+4}\" r=\"10\" fill=\"${c.y}\" stroke=\"#444\" stroke-width=\"1\"/>\n        <circle cx=\"${cx}\" cy=\"${cy+24}\" r=\"10\" fill=\"${c.g}\" stroke=\"#444\" stroke-width=\"1\"/>\n        <text x=\"${cx}\" y=\"${cy+52}\" text-anchor=\"middle\" fill=\"#ccc\" font-size=\"12\" font-weight=\"bold\">${label}</text>\n    </g>`;\n}\n\nlet svg = `<svg viewBox=\"0 0 300 300\" style=\"width:100%;max-width:300px;margin:auto;display:block;\">\n  <rect width=\"300\" height=\"300\" fill=\"#1a1a2e\" rx=\"10\"/>\n  <!-- Roads -->\n  <rect x=\"115\" y=\"0\" width=\"70\" height=\"300\" fill=\"#444\"/>\n  <rect x=\"0\" y=\"115\" width=\"300\" height=\"70\" fill=\"#444\"/>\n  <!-- Center -->\n  <rect x=\"115\" y=\"115\" width=\"70\" height=\"70\" fill=\"#555\"/>\n  <!-- Dashed lines -->\n  <line x1=\"150\" y1=\"0\" x2=\"150\" y2=\"110\" stroke=\"#aaa\" stroke-width=\"1\" stroke-dasharray=\"8,6\"/>\n  <line x1=\"150\" y1=\"190\" x2=\"150\" y2=\"300\" stroke=\"#aaa\" stroke-width=\"1\" stroke-dasharray=\"8,6\"/>\n  <line x1=\"0\" y1=\"150\" x2=\"110\" y2=\"150\" stroke=\"#aaa\" stroke-width=\"1\" stroke-dasharray=\"8,6\"/>\n  <line x1=\"190\" y1=\"150\" x2=\"300\" y2=\"150\" stroke=\"#aaa\" stroke-width=\"1\" stroke-dasharray=\"8,6\"/>\n  <!-- Traffic lights -->\n  ${light(150, 30, true, 'N')}\n  ${light(150, 226, true, 'S')}\n  ${light(40, 128, false, 'W')}\n  ${light(260, 128, false, 'E')}\n  <!-- Phase label -->\n  <text x=\"150\" y=\"156\" text-anchor=\"middle\" fill=\"#fff\" font-size=\"11\" font-weight=\"bold\">${phase}: ${pName}</text>\n</svg>`;\n\nmsg.payload = svg;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "// Initial state: all red\nconst svg = `<svg viewBox=\"0 0 300 300\" style=\"width:100%;max-width:300px;margin:auto;display:block;\"><rect width=\"300\" height=\"300\" fill=\"#1a1a2e\" rx=\"10\"/><text x=\"150\" y=\"155\" text-anchor=\"middle\" fill=\"#666\" font-size=\"14\">Waiting for state...</text></svg>`;\nnode.send({payload: svg});",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 440,
        "wires": [["ui.intersection"]]
    },
    {
        "id": "ui.intersection",
        "type": "ui_template",
        "z": "flow.traffic-dashboard",
        "group": "ui-group.intersection",
        "name": "Intersection SVG",
        "order": 1,
        "width": "6",
        "height": "8",
        "format": "<div ng-bind-html=\"msg.payload\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 590,
        "y": 440,
        "wires": [[]]
    }
]