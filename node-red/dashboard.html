<style>
  @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;800&display=swap");

  /* Reset & Scoped Variables */
  .tl-app {
    --bg-dark: #0b1120;
    --bg-card: #1e293b;
    --bg-card-hover: #334155;
    --text-primary: #f1f5f9;
    --text-muted: #94a3b8;
    --accent: #38bdf8;
    --success: #22c55e;
    --warning: #eab308;
    --danger: #ef4444;
    --border: #334155;

    font-family: "Inter", sans-serif;
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 800px; /* Force height */
    overflow: hidden;
  }

  /* Header */
  .tl-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: #0f172a;
    border-bottom: 1px solid var(--border);
  }
  .tl-brand h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: white;
  }
  .tl-brand small {
    color: var(--text-muted);
    font-size: 12px;
    font-family: "JetBrains Mono", monospace;
  }
  .tl-status-badge {
    padding: 6px 12px;
    border-radius: 99px;
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tl-status-badge.offline {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }
  .tl-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    box-shadow: 0 0 8px currentColor;
  }

  /* Main Grid Layout */
  .tl-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    padding: 24px;
    flex: 1;
    overflow-y: auto;
  }

  /* Cards */
  .tl-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  .tl-viz-card {
    grid-row: span 2;
    padding: 0;
    overflow: hidden;
    position: relative;
    background: #0f172a;
    border-color: #1e293b;
  }

  /* Right Sidebar Stack */
  .tl-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Stats Row (Overlay on Viz or separate?) -> Separate in sidebar for now */
  .tl-stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .tl-stat {
    background: #0f172a;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  .tl-stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .tl-stat-val {
    font-size: 18px;
    font-weight: 700;
    font-family: "JetBrains Mono", monospace;
  }

  /* Controls */
  .tl-ctrl-group {
    margin-bottom: 24px;
  }
  .tl-ctrl-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 12px;
    display: block;
  }
  .tl-btn-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .tl-btn {
    background: #0f172a;
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .tl-btn:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent);
    color: white;
    transform: translateY(-1px);
  }
  .tl-btn.active {
    background: var(--accent);
    color: #0f172a;
    border-color: var(--accent);
  }
  .tl-btn.red:hover {
    border-color: var(--danger);
  }
  .tl-btn.green:hover {
    border-color: var(--success);
  }
  .tl-btn.yellow:hover {
    border-color: var(--warning);
  }

  /* Log Table */
  .tl-log-wrap {
    flex: 1;
    overflow: auto;
    min-height: 200px;
  }
  table.tl-log {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    font-family: "JetBrains Mono", monospace;
  }
  table.tl-log th {
    text-align: left;
    color: var(--text-muted);
    padding: 8px;
    position: sticky;
    top: 0;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
  }
  table.tl-log td {
    padding: 8px;
    border-bottom: 1px solid #334155;
  }
  .tag {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
  }
  .tag.ok {
    background: rgba(34, 197, 94, 0.2);
    color: var(--success);
  }
  .tag.err {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
  }

  /* Responsive */
  @media (max-width: 1000px) {
    .tl-grid {
      grid-template-columns: 1fr;
    }
    .tl-viz-card {
      min-height: 400px;
    }
  }
</style>

<div class="tl-app">
  <!-- Header -->
  <header class="tl-header">
    <div class="tl-brand">
      <h1>TRAFFIC CONTROL</h1>
      <small>ID: city/demo/intersection/001</small>
    </div>
    <div class="tl-status-badge" ng-class="{offline: !dash.status.online}">
      <div class="tl-dot"></div>
      {{ dash.status.online ? 'ONLINE' : 'OFFLINE' }}
      <span style="opacity: 0.5; margin-left: 8px"
        >{{ dash.display.status_time }}</span
      >
    </div>
  </header>

  <div class="tl-grid">
    <!-- Center Visualization -->
    <div class="tl-card tl-viz-card">
      <div
        style="
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
        "
        ng-bind-html="dash.intersection_svg"
      >
        <!-- SVG injected here -->
      </div>
      <!-- Overlay Stats -->
      <div
        style="
          position: absolute;
          top: 20px;
          left: 20px;
          display: flex;
          gap: 12px;
        "
      >
        <div class="tl-stat">
          <div class="tl-stat-label">Phase</div>
          <div class="tl-stat-val">{{ dash.display.phase }}</div>
        </div>
        <div class="tl-stat">
          <div class="tl-stat-label">Mode</div>
          <div class="tl-stat-val" style="color: var(--accent)">
            {{ dash.display.mode }}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Controls -->
    <div class="tl-sidebar">
      <div class="tl-card">
        <span class="tl-ctrl-title">System Status</span>
        <div class="tl-stats-row">
          <div class="tl-stat">
            <div class="tl-stat-label">Uptime</div>
            <div class="tl-stat-val">{{ dash.display.uptime }}</div>
          </div>
          <div class="tl-stat">
            <div class="tl-stat-label">RSSI</div>
            <div class="tl-stat-val">{{ dash.display.rssi }}</div>
          </div>
          <div class="tl-stat">
            <div class="tl-stat-label">Heap</div>
            <div class="tl-stat-val">{{ dash.display.heap }}</div>
          </div>
          <div class="tl-stat">
            <div class="tl-stat-label">Latency</div>
            <div class="tl-stat-val">32ms</div>
            <!-- Mock -->
          </div>
        </div>
      </div>

      <div class="tl-card">
        <span class="tl-ctrl-title">Mode Control</span>
        <div class="tl-btn-grid">
          <div
            class="tl-btn"
            ng-click="sendMode('AUTO')"
            ng-class="{active: dash.display.mode=='AUTO'}"
          >
            AUTO
          </div>
          <div
            class="tl-btn"
            ng-click="sendMode('MANUAL')"
            ng-class="{active: dash.display.mode=='MANUAL'}"
          >
            MANUAL
          </div>
          <div
            class="tl-btn yellow"
            ng-click="sendMode('BLINK')"
            ng-class="{active: dash.display.mode=='BLINK'}"
          >
            BLINK
          </div>
          <div
            class="tl-btn red"
            ng-click="sendMode('OFF')"
            ng-class="{active: dash.display.mode=='OFF'}"
          >
            OFF
          </div>
        </div>

        <span class="tl-ctrl-title" style="margin-top: 20px"
          >Phase Control (Manual)</span
        >
        <div class="tl-btn-grid" style="grid-template-columns: 1fr 1fr 1fr">
          <div class="tl-btn green" ng-click="sendPhase(0)">NS Green</div>
          <div class="tl-btn yellow" ng-click="sendPhase(1)">Yellow</div>
          <div class="tl-btn red" ng-click="sendPhase(2)">Red</div>
          <div class="tl-btn green" ng-click="sendPhase(3)">EW Green</div>
          <div class="tl-btn yellow" ng-click="sendPhase(4)">Yellow</div>
          <div class="tl-btn red" ng-click="sendPhase(5)">Red</div>
        </div>
      </div>

      <div class="tl-card tl-log-wrap">
        <span class="tl-ctrl-title">Command Log</span>
        <table class="tl-log">
          <thead>
            <tr>
              <th>Time</th>
              <th>CMD</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="row in dash.ack_log">
              <td>{{ row.t }}</td>
              <td>{{ row.id }}</td>
              <td>
                <span class="tag" ng-class="row.ok ? 'ok':'err'"
                  >{{ row.ok?'OK':'ERR' }}</span
                >
              </td>
            </tr>
            <tr ng-if="!dash.ack_log.length">
              <td colspan="3" style="text-align: center; opacity: 0.5">
                No logs
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  (function (scope) {
    scope.dash = scope.dash || {
      status: { online: false },
      display: {
        mode: "--",
        phase: "--",
        uptime: "--",
        rssi: "--",
        heap: "--",
      },
      ack_log: [],
      intersection_svg: "",
    };
    scope.sendMode = function (mode) {
      scope.send({ topic: "ui/set_mode", payload: { mode: mode } });
    };
    scope.sendPhase = function (phase) {
      scope.send({ topic: "ui/set_phase", payload: { phase: phase } });
    };
    scope.$watch("msg", function (msg) {
      if (msg && msg.payload) scope.dash = msg.payload;
    });
  })(scope);
</script>
